"""
Tests for XOptionalAdapter.

This module tests the XOptionalAdapter class, which maintains two synchronized hooks
(one Optional[T], one T) and raises errors when None values are encountered.
"""

import pytest

from nexpy import XOptionalAdapter, FloatingHook

class TestXOptionalAdapterBasics:
    """Test basic functionality of XOptionalAdapter."""

    def test_initialization_with_value(self):
        """Test that XOptionalAdapter can be initialized with a value."""
        obs = XOptionalAdapter[int](
            hook_t_or_value=42,
            hook_optional=None
        )
        
        assert obs.hook_optional.value == 42
        assert obs.hook_t.value == 42

    def test_initialization_with_hook_optional(self):
        """Test initialization with hook_optional only."""
        hook_optional = FloatingHook[int | None](42)
        
        obs = XOptionalAdapter[int](
            hook_t_or_value=None,
            hook_optional=hook_optional
        )
        
        # The observable creates its own internal hooks and connects to the external one
        assert obs.hook_optional.value == 42
        assert obs.hook_t.value == 42

    def test_initialization_with_both_same_value(self):
        """Test initialization with both value and hook having the same value."""
        hook_optional = FloatingHook[int | None](42)
        
        obs = XOptionalAdapter(
            hook_t_or_value=42,
            hook_optional=hook_optional
        )
        
        assert obs.hook_optional.value == 42
        assert obs.hook_t.value == 42

    def test_initialization_with_different_values_raises_error(self):
        """Test that initialization with different values raises error."""
        hook_optional = FloatingHook[int | None](42)
        
        with pytest.raises(ValueError, match="Values do not match"):
            XOptionalAdapter(
                hook_t_or_value=100,
                hook_optional=hook_optional
            )

    def test_initialization_with_no_values_raises_error(self):
        """Test that initialization with no values raises error."""
        with pytest.raises(ValueError, match="At least one parameter must be provided"):
            XOptionalAdapter(
                hook_t_or_value=None,
                hook_optional=None
            )


class TestXOptionalAdapterValueUpdates:
    """Test value updates and synchronization."""

    def test_update_hook_without_none_updates_hook_optional(self):
        """Test that updating hook_t also updates hook_optional."""
        obs = XOptionalAdapter[int](
            hook_t_or_value=42,
            hook_optional=None
        )
        
        # Update hook_without_none
        obs._submit_values({"left": 100}) # type: ignore
        
        assert obs.hook_t.value == 100
        assert obs.hook_optional.value == 100

    def test_update_hook_optional_updates_hook_without_none(self):
        """Test that updating hook_optional also updates hook_t."""
        obs = XOptionalAdapter[int](
            hook_t_or_value=42,
            hook_optional=None
        )
        
        # Update hook_optional
        obs._submit_values({"right": 200}) # type: ignore
        
        assert obs.hook_optional.value == 200
        assert obs.hook_t.value == 200

    def test_update_both_hooks_with_same_value(self):
        """Test updating both hooks simultaneously with matching values."""
        obs = XOptionalAdapter[int](
            hook_t_or_value=42,
            hook_optional=None
        )
        
        # Update both with the same value
        obs._submit_values({ "left": 150, "right": 150}) # type: ignore
        assert obs.hook_optional.value == 150

    def test_update_string_values(self):
        """Test with string type instead of int."""
        obs = XOptionalAdapter[str](
            hook_t_or_value="hello",
            hook_optional=None
        )
        
        obs._submit_values({"left": "world"}) # type: ignore
        
        assert obs.hook_t.value == "world"
        assert obs.hook_optional.value == "world"


class TestXOptionalAdapterErrorHandling:
    """Test error handling when None values are submitted."""

    def test_update_hook_without_none_with_none_raises_error(self):
        """Test that updating hook_t with None raises SubmissionError."""
        from nexpy.core.nexus_system.submission_error import SubmissionError

        obs = XOptionalAdapter[int](
            hook_t_or_value=42,
            hook_optional=None
        )

        with pytest.raises(SubmissionError, match="Left validation failed"):
            obs.submit_values_by_keys({"left": None}) # type: ignore

    def test_update_hook_optional_with_none_raises_error(self):
        """Test that updating hook_optional with None raises SubmissionError."""
        from nexpy.core.nexus_system.submission_error import SubmissionError

        obs = XOptionalAdapter[int](
            hook_t_or_value=42,
            hook_optional=None
        )

        with pytest.raises(SubmissionError, match="Cannot convert None"):
            obs.submit_values_by_keys({"right": None}) # type: ignore 

    def test_update_both_hooks_with_none_raises_error(self):
        """Test that updating both hooks with None raises SubmissionError."""
        from nexpy.core.nexus_system.submission_error import SubmissionError

        obs = XOptionalAdapter[int](
            hook_t_or_value=42,
            hook_optional=None
        )

        with pytest.raises(SubmissionError, match="Left validation failed"):
            obs.submit_values_by_keys({"left": None,"right": None}) # type: ignore

    def test_update_both_hooks_with_mismatched_values(self):
        """Test updating both hooks with different values."""
        obs = XOptionalAdapter[int](
            hook_t_or_value=42,
            hook_optional=None
        )
        
        # When you submit both with different values, the system chooses one
        # (the sync system resolves this internally)
        obs._submit_values({ "left": 100, "right": 200}) # type: ignore

    def test_update_both_hooks_one_none_one_value_raises_error(self):
        """Test that updating with one None and one value raises SubmissionError."""
        from nexpy.core.nexus_system.submission_error import SubmissionError

        obs = XOptionalAdapter[int](
            hook_t_or_value=42,
            hook_optional=None
        )

        with pytest.raises(SubmissionError, match="Right validation failed"):
            obs.submit_values_by_keys({"left": 100, "right": None}) # type: ignore


class TestXOptionalAdapterHookAccess:
    """Test hook accessor methods."""

    def test_get_hook_left(self):
        """Test _get_hook returns correct hook for left key."""
        obs = XOptionalAdapter[int](
            hook_t_or_value=42,
            hook_optional=None
        )
        
        retrieved_hook = obs._get_hook_by_key("left") # type: ignore
        assert retrieved_hook is obs.hook_t

    def test_get_hook_right(self):
        """Test _get_hook returns correct hook for right key."""
        obs = XOptionalAdapter[int](
            hook_t_or_value=42,
            hook_optional=None
        )
        
        retrieved_hook = obs._get_hook_by_key("right") # type: ignore
        assert retrieved_hook is obs.hook_optional

    def test_get_value_reference_of_hook(self):
        """Test _get_value_reference_of_hook returns correct values."""
        obs = XOptionalAdapter[int](
            hook_t_or_value=42,
            hook_optional=None
        )
        
        left = obs._get_value_by_key("left") # type: ignore
        right = obs._get_value_by_key("right") # type: ignore 
        
        assert left == 42
        assert right == 42

    def test_get_hook_keys(self):
        """Test _get_hook_keys returns all keys."""
        obs = XOptionalAdapter[int](
            hook_t_or_value=42,
            hook_optional=None
        )
        
        keys = obs._get_hook_keys() # type: ignore
        assert keys == {"left", "right"}

    def test_get_hook_key(self):
        """Test _get_hook_key returns correct key for given hook."""
        obs = XOptionalAdapter[int](
            hook_t_or_value=42,
            hook_optional=None
        )
        
        key_without = obs._get_key_by_hook_or_nexus(obs.hook_t) # type: ignore
        key_with = obs._get_key_by_hook_or_nexus(obs.hook_optional) # type: ignore
        
        assert key_without == "left"
        assert key_with == "right"

    def test_get_hook_key_invalid_hook_raises_error(self):
        """Test _get_hook_key raises error for unknown hook."""
        unknown_hook = FloatingHook[int](99)
        
        obs = XOptionalAdapter[int](
            hook_t_or_value=42,
            hook_optional=None
        )
        
        with pytest.raises(ValueError, match="not found in"):
            obs._get_key_by_hook_or_nexus(unknown_hook) # type: ignore


class TestXOptionalAdapterValidation:
    """Test validation functionality."""

    def test_validate_with_matching_non_none_values(self):
        """Test validation succeeds with matching non-None values."""
        obs = XOptionalAdapter[int](
            hook_t_or_value=42,
            hook_optional=None
        )
        
        # Access the validation callback directly
        is_valid, message = obs._validate_values( # type: ignore
            {"left": 42, "right": 42} # type: ignore
        )
        
        assert is_valid is True
        assert message == "Values are valid"

    def test_validate_with_mismatched_values(self):
        """Test validation fails when hooks have mismatched non-None values."""
        obs = XOptionalAdapter[int](
            hook_t_or_value=42,
            hook_optional=None
        )
        
        is_valid, message = obs._validate_values( # type: ignore
            {"left": 42, "right": 100} # type: ignore
        )
        
        # Validation fails - both hooks must have matching values since they're joined
        assert is_valid is False
        assert "Values are inconsistent" in message

    def test_validate_with_none_values(self):
        """Test validation fails when values are None."""
        obs = XOptionalAdapter[int](
            hook_t_or_value=42,
            hook_optional=None
        )
        
        is_valid, message = obs._validate_values( # type: ignore
            {"left": None, "right": None} # type: ignore
        )
        
        assert is_valid is False
        assert "Left validation failed" in message

    def test_validate_with_missing_keys(self):
        """Test validation succeeds with one key - the other is automatically added."""
        obs = XOptionalAdapter[int](
            hook_t_or_value=42,
            hook_optional=None
        )
        
        is_valid, message = obs._validate_values( # type: ignore
            {"left": 42} # type: ignore
        )
        
        # Should succeed - the system automatically adds the other value
        assert is_valid is True


class TestXOptionalAdapterListeners:
    """Test that listeners work correctly with XOptionalAdapter."""

    def test_listener_triggered_on_update(self):
        """Test that listeners are triggered when values update."""
        obs = XOptionalAdapter[int](
            hook_t_or_value=42,
            hook_optional=None
        )
        
        without_none_updates: list[int] = []
        with_none_updates: list[int] = []
        
        def listener_without():
            without_none_updates.append(obs.hook_t.value)
        
        def listener_with():
            with_none_updates.append(obs.hook_optional.value) # type: ignore
        
        obs.hook_t.add_listener(listener_without)
        obs.hook_optional.add_listener(listener_with)
        
        # Update via left
        obs._submit_values({"left": 100}) # type: ignore
        
        assert without_none_updates == [100]
        assert with_none_updates == [100]

    def test_listener_triggered_on_synchronized_update(self):
        """Test that both listeners are triggered when one value updates."""
        obs = XOptionalAdapter[int](
            hook_t_or_value=42,
            hook_optional=None
        )
        
        update_count = {"with": 0, "without": 0}
        
        def listener_without():
            update_count["without"] += 1
        
        def listener_with():
            update_count["with"] += 1
        
        obs.hook_t.add_listener(listener_without)
        obs.hook_optional.add_listener(listener_with)
        
        # Update via right
        obs._submit_values({"right": 200}) # type: ignore
        
        # Both should be triggered because the observable syncs them
        assert update_count["with"] == 1
        assert update_count["without"] == 1


class TestXOptionalAdapterComplexTypes:
    """Test XOptionalAdapter with complex types."""

    def test_with_list_type(self):
        """Test with list values."""
        obs = XOptionalAdapter[list[int]](
            hook_t_or_value=[1, 2, 3],
            hook_optional=None
        )
        
        new_list = [4, 5, 6]
        obs._submit_values({"left": new_list}) # type: ignore
        
        # Values are stored as-is (no immutability conversion)
        assert obs.hook_t.value == [4, 5, 6]
        assert obs.hook_optional.value == [4, 5, 6]

    def test_with_dict_type(self):
        """Test with dict values."""
        initial_dict = {"a": 1, "b": 2}
        obs = XOptionalAdapter[dict[str, int]](
            hook_t_or_value=initial_dict,
            hook_optional=None
        )
        
        new_dict = {"c": 3, "d": 4}
        obs._submit_values({"right": new_dict}) # type: ignore
        
        # Values are stored as-is (no immutability conversion)
        assert obs.hook_t.value == {"c": 3, "d": 4}
        assert obs.hook_optional.value == {"c": 3, "d": 4}

class TestXOptionalAdapterEdgeCases:
    """Test edge cases and boundary conditions."""

    def test_empty_update(self):
        """Test submitting empty update dict."""
        obs = XOptionalAdapter[int](
            hook_t_or_value=42,
            hook_optional=None
        )
        
        # Empty update should do nothing
        obs._submit_values({}) # type: ignore
        
        assert obs.hook_t.value == 42
        assert obs.hook_optional.value == 42

    def test_multiple_sequential_updates(self):
        """Test multiple updates in sequence."""
        obs = XOptionalAdapter[int](
            hook_t_or_value=0,
            hook_optional=None
        )
        
        for i in range(1, 6):
            obs._submit_values({"left": i}) # type: ignore
            assert obs.hook_t.value == i
            assert obs.hook_optional.value == i

    def test_update_with_same_value(self):
        """Test updating with the same value doesn't cause issues."""
        obs = XOptionalAdapter[int](
            hook_t_or_value=42,
            hook_optional=None
        )
        
        # Update with same value
        obs._submit_values({"left": 42}) # type: ignore
        
        assert obs.hook_t.value == 42
        assert obs.hook_optional.value == 42

